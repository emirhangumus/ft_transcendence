<div class="w-full bg-white border border-[#e0e0e0] rounded-md p-4">
    <p class="font-bold">{{ chatRoom.name }}</p>
</div>
<div class="min-h-[900px] w-full flex-1 bg-white border border-[#e0e0e0] rounded-md p-4 overflow-y-auto" id="chat-log">
    <p id="there-is-no-message">There is no message</p>
</div>
<form class="w-full flex justify-between items-center" id="chat-form-messsager">
    <input type="text" name="content" class="w-4/5 h-full border border-[#e0e0e0] rounded-md p-2" id="chat-message-input">
    <button id="chat-message-submit"
        class="w-1/5 h-full bg-[#f5f5f5] hover:bg-[#e0e0e0] border border-[#e0e0e0] p-2 rounded-md">Send</button>
    <input type="hidden" name="chat_id" id="chatID" value="{{ chatRoom.chat_id }}">
</form>
<script>
{
    const messageTemplate = (user, message, created_at) => `
    <div class="flex justify-between items-center">
        <div>
            <a href="/profile/${user}" class="font-bold">${user}</a>
            <p>${message}</p>
        </div>
        <div>
            <p>${new Date(created_at).toLocaleString()}</p>
        </div>
    </div>
    `;
    
    const roomID = document.getElementById('chatID').value;
    const log = document.getElementById('chat-log');
    const thereIsNoMessage = document.getElementById('there-is-no-message');
    
    const chatSocket = new WebSocket(
        'wss://'
        + window.location.host
        + '/api/v1/chat/'
        + roomID
        + '/ws/'
    ); // -> ws://localhost:8000/api/v1/chat/1/ws/

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        thereIsNoMessage.style.display = 'none';
        log.innerHTML += messageTemplate(data.username, data.message, data.created_at ?? new Date());
        disableAllAnchorTags();
    };

    chatSocket.onclose = function(e) {
        console.log('Chat socket closed');
    };

    const form = document.getElementById('chat-form-messsager');
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const messageInputDom = document.getElementById('chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'username': '{{ user }}',
        }));
        messageInputDom.value = '';
    });

    cleanupFunctions.push(() => {
        chatSocket.close();
    });
}
</script>